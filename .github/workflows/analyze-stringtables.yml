name: Save old stringtable.ini if changed
on:
  push:

jobs:
  analyze-stringtables:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Search for edited stringtable.ini files
        id: diffcheck
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep stringtable.ini || true)
          CHANGED_FILES_CSV=$(echo "$CHANGED_FILES" | paste -sd "," -)
          echo "Found changed files: $CHANGED_FILES_CSV"
          echo "changed_files=$CHANGED_FILES_CSV" >> $GITHUB_OUTPUT

      - name: Save old stringtable.ini files
        if: steps.diffcheck.outputs.changed_files != ''
        run: |
          IFS=',' read -ra FILES <<< "${{ steps.diffcheck.outputs.changed_files }}"
          for FILE in "${FILES[@]}"; do
            if echo "$FILE" | grep -q "stringtable.ini"; then
              DIR=$(dirname "$FILE")
              TARGET_DIR="tmp/$DIR"
              mkdir -p "$TARGET_DIR"
              if git ls-tree -r HEAD~1 --name-only | grep -q "^$FILE$"; then
                git show HEAD~1:$FILE > "$TARGET_DIR/stringtable_old.ini"
                echo "Saved old stringtable.ini to $TARGET_DIR/stringtable_old.ini"
              else
                echo "File $FILE did not exist in HEAD~1 â€“ not saved."
              fi
            fi
          done

      - name: Run analyze.js
        run: node scripts/analyze.js
