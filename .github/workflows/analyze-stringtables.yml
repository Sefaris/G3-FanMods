name: Analyze All Stringtables

on:
  push:

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Collect all stringtable.ini files (HEAD & HEAD^)
        run: |
          mkdir -p tmp

          # 1. Pliki z obecnego commita
          find . -type f -path '**/stringtable.ini' > tmp/current_files.txt

          # 2. Pliki z poprzedniego commita
          git ls-tree -r --name-only HEAD^ | grep 'stringtable.ini$' > tmp/previous_files.txt || true

          # 3. Połączenie i unifikacja
          cat tmp/current_files.txt tmp/previous_files.txt | sed 's|^\./||' | sort | uniq > tmp/all_stringtables.txt

          echo "[" > tmp/diff.json
          count=0

          while IFS= read -r file; do
            before_content="$(git show HEAD^:"$file" 2>/dev/null || echo "")"
            after_content="$(cat "$file" 2>/dev/null || echo "")"

            json_entry=$(jq -Rn \
              --arg path "$file" \
              --arg before "$before_content" \
              --arg after "$after_content" \
              '{path: $path, before: $before, after: $after}')

            if [ $count -gt 0 ]; then
              echo "," >> tmp/diff.json
            fi

            echo "$json_entry" >> tmp/diff.json
            count=$((count+1))
          done < tmp/all_stringtables.txt

          echo "]" >> tmp/diff.json

      - name: Run analyze.js
        run: node scripts/analyze.js
        env:
          FILE_DIFFS_PATH: ${{ github.workspace }}/tmp/diff.json
