name: Save old stringtable.ini if changed
on:
  push:

jobs:
  analyze-stringtables:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # needed to get HEAD~1

      - name: Search for edited stringtable.ini files
        id: diffcheck
        run: |
          CHANGED_FILE=$(git diff --name-only HEAD~1 HEAD | grep stringtable.ini || true)
          echo "Found changed file: $CHANGED_FILE"
          echo "changed_file=$CHANGED_FILE" >> $GITHUB_OUTPUT

      - name: Save old stringtable.ini
        if: steps.diffcheck.outputs.changed_file != ''
        run: |
          FILE="${{ steps.diffcheck.outputs.changed_file }}"

          if echo "$FILE" | grep -q "stringtable.ini"; then
            DIR=$(dirname "$FILE")
            TARGET_DIR="tmp/$DIR"

            mkdir -p "$TARGET_DIR"

            if git ls-tree -r HEAD~1 --name-only | grep -q "^$FILE$"; then
              git show HEAD~1:$FILE > "$TARGET_DIR/stringtable_old.ini"
              echo "Saved old stringtable.ini as $TARGET_DIR/stringtable_old.ini"
            else
              echo "File $FILE did not exist in HEAD~1 â€“ not saved."
            fi
          else
            echo "File stringtable.ini not found"
          fi
      - name: Run analyze.js
        run: |
          node scripts/analyze.js